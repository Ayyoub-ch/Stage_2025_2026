But d'aujourd'hui

-Faire les endpoints de l'API Covid :

- By Date
- By Period


-Mettre l'API Ã  disposition de Streamlit



Dans le cas oÃ¹ je termine :
- Fusionner les donnÃ©es cinema et covid dans l'application Streamlit pour voir le rendu

DifficultÃ©s:
Chercher la date demandÃ©e dans le fichier en question : prendre l'annÃ©e et chercher dedans (le parser)
prendre les informations prÃ©sentes dans le fichier en s'arretant aux bornes
si l'annÃ©e de fin est diffÃ©rente de celle de de dÃ©but alors on prend tout ce qui est entre les deux dates soient par exemple
entre 2020-01-15 et 2022-01-12 il y a toute l'annÃ©e 2021


if category not in METEO_CATEGORIES:
        raise HTTPException(400, "Invalid category")

    start = datetime.strptime(start_date, "%Y-%m-%d")
    end = datetime.strptime(end_date, "%Y-%m-%d")

    years = get_years_in_range(start, end)

    all_data = []
    for year in years:
        blobs = get_blobs_for_year(year)
        data = await download_blobs_parallel(blobs)
        all_data.extend(data)

    fields = COMMON_FIELDS + METEO_CATEGORIES[category]
    start_str = date_debut.replace("-", "")
    end_str = date_fin.replace("-", "")



ğŸ”´ LE PROBLÃˆME RÃ‰EL (important)

ğŸ‘‰ Tu nâ€™as PAS des fichiers journaliers.
ğŸ‘‰ Tu as des fichiers annuels :

Donnees_France/2020/covid_2020.json
Donnees_France/2021/covid_2021.json


Et dans ton code tu fais :

prefix = f"{FOLDER_COVID}/{current.year}/covid_{current.year}.json"


â¡ï¸ Quel que soit le jour, tu tÃ©lÃ©charges LE MÃŠME FICHIER DE Lâ€™ANNÃ‰E.

Donc cette boucle :

current = start
while current <= end:
    ...
    blobs = list(bucket_covid.list_blobs(prefix=prefix))
    all_blobs.extend(blobs)
    current += timedelta(days=1)


âŒ ne filtre RIEN
âŒ ajoute le mÃªme blob 365 fois
âŒ et download_blobs_parallel lit le JSON annuel complet

ğŸ‘‰ RÃ©sultat logique : toute lâ€™annÃ©e.

ğŸ§  RÃˆGLE Dâ€™OR Ã€ RETENIR

ğŸ”¹ On ne peut PAS filtrer par date avec GCS si la date nâ€™est PAS dans le nom du fichier.
ğŸ”¹ Le filtrage DOIT se faire APRÃˆS le tÃ©lÃ©chargement du JSON.

âœ… LA BONNE STRATÃ‰GIE (dans ton cas)
âœ”ï¸ Ã‰tape 1 â€” TÃ©lÃ©charger UNE FOIS le fichier annuel
âœ”ï¸ Ã‰tape 2 â€” Filtrer les entrÃ©es JSON par date
